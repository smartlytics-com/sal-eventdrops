{"version":3,"sources":["../src/udseventdrops_ctrl.js"],"names":["MetricsPanelCtrl","_","d3","eventDrops","panelDefaults","bgColor","labels","title","subtitle","x_legend","y_legend","fields","x_label","y_label","name_label","window","global","UdsEventdropsCtrl","$scope","$injector","$rootScope","defaultsDeep","panel","events","on","onInitEditMode","bind","onPanelTeardown","render","onRender","onDataReceived","onDataError","data","canvasid","Math","random","replace","ctx","chart","ready","updateChart","series","config","start","dashboard","time","from","toDate","end","to","blurDeviation","colorMatrix","color","index","schemeCategory10","height","padding","text","d","name","width","radius","date","Date","select","console","log","call","fulldata","dataList","new_datagroups","set","laneIdx","columns","findIndex","item","labelIdx","pointIdx","colorIdx","radiusIdx","rows","forEach","lane","row","entry","laneArray","push","length","Object","entries","addEditorTab","$timeout","cancel","nextTickPromise","templateUrl"],"mappings":"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","file":"udseventdrops_ctrl.js","sourcesContent":["import {\n  MetricsPanelCtrl,\n}\nfrom 'app/plugins/sdk';\nimport _ from 'lodash';\nimport './eventdrops/eventdrops.css!';\nimport * as d3 from './eventdrops/d3.v5.min.js';\nimport eventDrops from './eventdrops/eventdrops.min';\n\nconst panelDefaults = {\n  bgColor: null,\n\n  labels: {\n    title: null,\n    subtitle: null,\n    x_legend: null,\n    y_legend: null\n  },\n\n  fields: {\n    x_label: null,\n    y_label: null,\n    name_label: null,\n  }\n\n};\n\nwindow.global = window;\n\nexport class UdsEventdropsCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    _.defaultsDeep(this.panel, panelDefaults);\n\n    this.$rootScope = $rootScope;\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n    this.events.on('panel-initialized', this.render.bind(this));\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n\n    this.data = [];\n    this.canvasid = ('id' + (Math.random() * 100000)).replace('.', '');\n    this.ctx = null;\n    this.chart = null;\n    this.eventDrops = null;\n    this.ready = false;\n\n    this.updateChart();\n  }\n\n  onDataError() {\n    //console.log('Data error');\n    this.series = [];\n    this.render();\n  }\n\n  updateChart() {\n  }\n\n  onRender() {\n    let config = {d3};\n    config['range'] = {start: this.dashboard.time.from.toDate(), end: this.dashboard.time.to.toDate()};\n    //config['bound'] = {format: d3.timeFormat('%d %B \\'%y %H:%M:%S')};\n    //config['zoom'] = {onZoomStart: null,onZoom: null,onZoomEnd: null,minimumScale: 0,maximumScale: Infinity};\n    config['metaballs'] = {blurDeviation: 1000, colorMatrix: '1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 50 -10'};\n    config['line'] = {color: (_, index) => d3.schemeCategory10[index], height: 40};\n    config['label'] = {padding: 5,text: d => `${d.name}`,width: 10}; //config['label'] = {padding: 5,text: d => `${d.name} (${d.data.length})`,width: 100};\n    config['drop'] = {color: d => d.color || 'blue', radius: d => d.radius || 2, date: d => new Date(d.date)};\n    //config['drop'] = {color: d => d.color || 'blue', radius: d => d.radius || 2, date: d => new Date(d.date), onClick: event => {}, onMouseOver: event => {console.log('smu', event)}, onMouseOut: event => {}};\n    this.eventDrops = eventDrops( config );\n    this.chart = d3.select(\"#\" + this.canvasid);\n\n    if (this.data && this.eventDrops) {\n        console.log('draw',this.data);\n        let global = window;\n        this.chart.data([this.data]).call(this.eventDrops);\n        //console.log(new Date('2018-12-03 23:35:00'));\n        //this.chart.data([[{name:'Smu', color:'yellow', data:[{date:'2018-12-03 23:55:00'}]}]]).call(this.eventDrops);\n    }\n\n    //this.chart.render();\n  }\n\n  decodeNonHistoricalData(fulldata) {\n    this.updateChart();\n  }\n\n  //***************************************************\n  // Data received\n  //***************************************************\n  onDataReceived(dataList) {\n    let new_datagroups = {};\n    for (let set = 0; set < dataList.length; set++) {\n        let laneIdx = dataList[set].columns.findIndex(item=>item.text == \"lane\");\n        let labelIdx = dataList[set].columns.findIndex(item=>item.text == \"label\");\n        let pointIdx = dataList[set].columns.findIndex(item=>item.text == \"point\");\n        let colorIdx = dataList[set].columns.findIndex(item=>item.text == \"color\");\n        let radiusIdx = dataList[set].columns.findIndex(item=>item.text == \"radius\");\n\n        dataList[set].rows.forEach(row => {\n            let lane = row[laneIdx];\n            let entry = {\n                'date' : new Date(row[pointIdx]),\n                'label' : row[labelIdx],\n                'color' : (colorIdx>-1) ? row[colorIdx] : 'blue',\n                'radius' : (radiusIdx>-1) ? row[radiusIdx] : 1\n            };\n            let laneArray = new_datagroups[lane] || [];\n            laneArray.push(entry);\n            new_datagroups[lane] = laneArray;\n        });\n    }\n    this.data = [];\n    Object.entries(new_datagroups).forEach(entry => {\n        this.data.push({name:entry[0], data:entry[1], color: \"blue\"});\n    });\n\n    this.updateChart();\n    this.render();\n  }\n\n  onInitEditMode() {\n    //console.log('onInitEditMode');\n    this.addEditorTab('Options', 'public/plugins/uds-eventdrops-panel/editor.html', 2);\n  }\n\n  onPanelTeardown() {\n    //console.log('onPanelTeardown');\n    this.$timeout.cancel(this.nextTickPromise);\n  }\n\n}\n\nUdsEventdropsCtrl.templateUrl = 'module.html';"]}